<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Minna Match - Verb Master</title>
    <style>
        :root {
            --peppa-sky: #87CEEB;
            --peppa-pink: #FFC0CB;
            --peppa-dark-pink: #FF69B4;
            --peppa-red: #FF4500;
            --peppa-blue: #1E90FF;
            --peppa-green: #90EE90;
            --peppa-grass: #32CD32;
            --peppa-yellow: #FFFFE0;
            --bg-color: #87CEEB;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }
        
        /* Screens */
        .screen {
            width: 100%;
            height: 100%;
            padding: 1rem;
            padding-top: calc(env(safe-area-inset-top) + 20px);
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Selection Screen */
        #selection-screen {
            background: linear-gradient(180deg, var(--peppa-sky) 0%, #fff 100%);
            align-items: center;
        }

        .title-area {
            text-align: center;
            margin-bottom: 2rem;
        }

        .mode-section {
            background: rgba(255,255,255,0.8);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--peppa-pink);
            padding-bottom: 0.5rem;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s;
            text-align: center;
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-blue { background-color: var(--peppa-blue); }
        .btn-pink { background-color: var(--peppa-dark-pink); }
        .btn-green { background-color: var(--peppa-green); color: #005500; }

        /* Checkbox Grid for Verbs */
        .verb-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }
        .verb-opt {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #666;
        }
        .verb-opt.selected {
            background-color: var(--peppa-pink);
            border-color: var(--peppa-dark-pink);
            color: white;
        }

        /* Game Screen */
        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.9);
            border-radius: 50px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #game-grid {
            display: flex;
            gap: 0.8rem;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        .col { flex: 1; display: flex; flex-direction: column; gap: 0.8rem; }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 0.5rem;
            min-height: 4.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 4px solid #eee;
            font-size: 1.1rem; /* Slightly larger text */
            cursor: pointer;
            position: relative;
            animation: fadeIn 0.3s;
        }
        .card span { pointer-events: none; }
        
        .card.selected { background-color: var(--peppa-blue); color: white; border-bottom-color: #1565c0; transform: scale(1.02); z-index: 10; }
        .card.matched { opacity: 0; transform: scale(0); pointer-events: none; transition: all 0.5s; }
        .card.error { background-color: var(--peppa-red); color: white; animation: shake 0.4s; }

        /* Modal */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 2rem;
            text-align: center;
            width: 85%;
            max-width: 320px;
            animation: bounceIn 0.5s;
        }

        /* Ruby Support */
        ruby { display: inline-flex; flex-direction: column-reverse; align-items: center; }
        rt { font-size: 0.6em; margin-bottom: 0.2em; opacity: 0.7; }
        
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        @keyframes bounceIn { 0%{transform:scale(0.3)} 60%{transform:scale(1.1)} 100%{transform:scale(1)} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    </style>
</head>
<body>

    <!-- Selection Screen -->
    <div id="selection-screen" class="screen">
        <div class="title-area">
            <div style="font-size: 3.5rem;">ğŸ·</div>
            <h1 style="margin: 0.5rem 0; color: var(--peppa-blue);">æ—¥è¯­é…å¯¹</h1>
            <p style="margin:0; color:#666; font-size:0.9rem;">ä¿®å¤ç‰ˆ v3.0 - åŠ¨è¯åˆ†ç±»å›å½’</p>
        </div>

        <!-- Mode 1: Vocabulary -->
        <div class="mode-section">
            <div class="section-title">ğŸ“š å•è¯æ¨¡å¼</div>
            <button class="btn btn-blue" onclick="startGame('N3')">N3 æ ¸å¿ƒè¯æ±‡</button>
            <button class="btn btn-green" onclick="startGame('N5')">N4/N5 åŸºç¡€è¯æ±‡</button>
        </div>

        <!-- Mode 2: Verb Conjugation -->
        <div class="mode-section">
            <div class="section-title">âš¡ åŠ¨è¯å˜å½¢ç‰¹è®­</div>
            <div class="verb-options" id="verb-options">
                <div class="verb-opt" data-form="masu" onclick="toggleVerbOpt(this)">ã¾ã™å½¢</div>
                <div class="verb-opt" data-form="te" onclick="toggleVerbOpt(this)">ã¦å½¢</div>
                <div class="verb-opt" data-form="nai" onclick="toggleVerbOpt(this)">ãªã„å½¢</div>
                <div class="verb-opt" data-form="ta" onclick="toggleVerbOpt(this)">ãŸå½¢</div>
            </div>
            <button class="btn btn-pink" style="margin-top:1rem;" onclick="startVerbGame()">å¼€å§‹å˜å½¢ç»ƒä¹ </button>
        </div>
        
        <div style="text-align:center; color:#888; font-size:0.8rem; padding:1rem;">
            ğŸ’¡ æç¤ºï¼šè‹¹æœæ‰‹æœºè¯·å…³é—­é™éŸ³æ¨¡å¼ä»¥æ’­æ”¾å£°éŸ³
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen hidden">
        <div id="game-header">
            <button onclick="quitGame()" style="background:none;border:none;font-size:1.5rem;">ğŸ </button>
            <div style="font-weight:bold; color:var(--peppa-blue); font-size:1.2rem;" id="score-display">0 / 7</div>
            <div style="width:24px;"></div> <!-- Spacer -->
        </div>
        <div id="game-grid">
            <div id="col-left" class="col"></div>
            <div id="col-right" class="col"></div>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="modal-overlay" class="hidden">
        <div class="modal-content">
            <div style="font-size:4rem; margin-bottom:1rem;">ğŸ‰</div>
            <h2 style="color:var(--peppa-dark-pink); margin-bottom:0.5rem;">å¤ªæ£’äº†!</h2>
            <p>æ‰€æœ‰å•è¯é…å¯¹æˆåŠŸï¼</p>
            <button class="btn btn-blue" onclick="quitGame()">è¿”å›èœå•</button>
        </div>
    </div>

    <script>
        // --- DATA: Expanded with Verb Groups ---
        // Groups: 1 (u-verbs), 2 (ru-verbs), 3 (irregular)
        const VERBS = [
            { id: 'v1', kanji: 'è¡Œ', kana: 'ã„', end: 'ã', group: 1, meaning: 'å»' },
            { id: 'v2', kanji: 'é£²', kana: 'ã®', end: 'ã‚€', group: 1, meaning: 'å–' },
            { id: 'v3', kanji: 'èª­', kana: 'ã‚ˆ', end: 'ã‚€', group: 1, meaning: 'è¯»' },
            { id: 'v4', kanji: 'è²·', kana: 'ã‹', end: 'ã†', group: 1, meaning: 'ä¹°' },
            { id: 'v5', kanji: 'å¾…', kana: 'ã¾', end: 'ã¤', group: 1, meaning: 'ç­‰' },
            { id: 'v6', kanji: 'å¸°', kana: 'ã‹ãˆ', end: 'ã‚‹', group: 1, meaning: 'å›å®¶' },
            { id: 'v7', kanji: 'è©±', kana: 'ã¯ãª', end: 'ã™', group: 1, meaning: 'è¯´è¯' },
            { id: 'v8', kanji: 'æ³³', kana: 'ãŠã‚ˆ', end: 'ã', group: 1, meaning: 'æ¸¸æ³³' },
            { id: 'v9', kanji: 'éŠ', kana: 'ã‚ã', end: 'ã¶', group: 1, meaning: 'ç©' },
            { id: 'v10', kanji: 'æ­»', kana: 'ã—', end: 'ã¬', group: 1, meaning: 'æ­»' },
            { id: 'v11', kanji: 'é£Ÿ', kana: 'ãŸ', end: 'ã¹ã‚‹', group: 2, meaning: 'åƒ' },
            { id: 'v12', kanji: 'è¦‹', kana: 'ã¿', end: 'ã‚‹', group: 2, meaning: 'çœ‹' },
            { id: 'v13', kanji: 'å¯', kana: 'ã­', end: 'ã‚‹', group: 2, meaning: 'ç¡è§‰' },
            { id: 'v14', kanji: 'èµ·', kana: 'ãŠ', end: 'ãã‚‹', group: 2, meaning: 'èµ·åºŠ' },
            { id: 'v15', kanji: 'å€Ÿ', kana: 'ã‹', end: 'ã‚Šã‚‹', group: 2, meaning: 'å€Ÿå…¥' },
            { id: 'v16', kanji: '', kana: '', end: 'ã™ã‚‹', group: 3, meaning: 'åš(Suru)' },
            { id: 'v17', kanji: '', kana: '', end: 'ãã‚‹', group: 3, meaning: 'æ¥(Kuru)' },
            { id: 'v18', kanji: 'å‹‰å¼·', kana: 'ã¹ã‚“ãã‚‡ã†', end: 'ã™ã‚‹', group: 3, meaning: 'å­¦ä¹ ' },
        ];

        const VOCAB_N3 = [
             { id: 'n3_1', kanji: '[çµŒé¨“](ã‘ã„ã‘ã‚“)', kana: 'ã‘ã„ã‘ã‚“', meaning: 'ç»éªŒ' },
             { id: 'n3_2', kanji: '[ç¿’æ…£](ã—ã‚…ã†ã‹ã‚“)', kana: 'ã—ã‚…ã†ã‹ã‚“', meaning: 'ä¹ æƒ¯' },
             { id: 'n3_3', kanji: '[è£½å“](ã›ã„ã²ã‚“)', kana: 'ã›ã„ã²ã‚“', meaning: 'äº§å“' },
             { id: 'n3_4', kanji: '[æ³•å¾‹](ã»ã†ã‚Šã¤)', kana: 'ã»ã†ã‚Šã¤', meaning: 'æ³•å¾‹' },
             { id: 'n3_5', kanji: '[å¹³å‡](ã¸ã„ãã‚“)', kana: 'ã¸ã„ãã‚“', meaning: 'å¹³å‡' },
             { id: 'n3_6', kanji: '[åŸå› ](ã’ã‚“ã„ã‚“)', kana: 'ã’ã‚“ã„ã‚“', meaning: 'åŸå› ' },
             { id: 'n3_7', kanji: '[åœ°çƒ](ã¡ãã‚…ã†)', kana: 'ã¡ãã‚…ã†', meaning: 'åœ°çƒ' },
             { id: 'n3_8', kanji: '[æŠ€è¡“](ãã˜ã‚…ã¤)', kana: 'ãã˜ã‚…ã¤', meaning: 'æŠ€æœ¯' },
             { id: 'n3_9', kanji: '[å°†æ¥](ã—ã‚‡ã†ã‚‰ã„)', kana: 'ã—ã‚‡ã†ã‚‰ã„', meaning: 'å°†æ¥' },
             { id: 'n3_10', kanji: '[æ‰‹è¡“](ã—ã‚…ã˜ã‚…ã¤)', kana: 'ã—ã‚…ã˜ã‚…ã¤', meaning: 'æ‰‹æœ¯' },
             { id: 'n3_a1', kanji: '[è¤‡é›‘](ãµãã–ã¤)', kana: 'ãµãã–ã¤', meaning: 'å¤æ‚' },
             { id: 'n3_a2', kanji: '[ä¸å¯§](ã¦ã„ã­ã„)', kana: 'ã¦ã„ã­ã„', meaning: 'ç¤¼è²Œ' },
             { id: 'n3_a3', kanji: '[å±é™º](ãã‘ã‚“)', kana: 'ãã‘ã‚“', meaning: 'å±é™©' }
        ];

        const VOCAB_N5 = [
            { id: 'm1', kanji: '[çŒ«](ã­ã“)', kana: 'ã­ã“', meaning: 'çŒ«' },
            { id: 'm2', kanji: '[çŠ¬](ã„ã¬)', kana: 'ã„ã¬', meaning: 'ç‹—' },
            { id: 'm3', kanji: '[æ°´](ã¿ãš)', kana: 'ã¿ãš', meaning: 'æ°´' },
            { id: 'm4', kanji: '[æœ¬](ã»ã‚“)', kana: 'ã»ã‚“', meaning: 'ä¹¦' },
            { id: 'm5', kanji: '[å­¦æ ¡](ãŒã£ã“ã†)', kana: 'ãŒã£ã“ã†', meaning: 'å­¦æ ¡' },
            { id: 'm6', kanji: '[å‹é”](ã¨ã‚‚ã ã¡)', kana: 'ã¨ã‚‚ã ã¡', meaning: 'æœ‹å‹' },
            { id: 'm7', kanji: '[å¤©æ°—](ã¦ã‚“ã)', kana: 'ã¦ã‚“ã', meaning: 'å¤©æ°”' },
            { id: 'm8', kanji: '[éƒ¨å±‹](ã¸ã‚„)', kana: 'ã¸ã‚„', meaning: 'æˆ¿é—´' },
            { id: 'm9', kanji: '[å…ˆç”Ÿ](ã›ã‚“ã›ã„)', kana: 'ã›ã‚“ã›ã„', meaning: 'è€å¸ˆ' },
            { id: 'm10', kanji: '[å­¦ç”Ÿ](ãŒãã›ã„)', kana: 'ãŒãã›ã„', meaning: 'å­¦ç”Ÿ' }
        ];

        // --- CONJUGATOR LOGIC (No AI needed!) ---
        function conjugate(verb, formType) {
            const stem = verb.kanji ? `[${verb.kanji}](${verb.kana})` : verb.kana; // Simplified for display
            const plainEnd = verb.end;
            let resultEnd = '';

            if (verb.group === 1) {
                // U-verbs
                if (formType === 'masu') {
                    const map = {'ã†':'ã„','ã':'ã','ã':'ã','ã™':'ã—','ã¤':'ã¡','ã¬':'ã«','ã¶':'ã³','ã‚€':'ã¿','ã‚‹':'ã‚Š'};
                    resultEnd = map[plainEnd] + 'ã¾ã™';
                } else if (formType === 'nai') {
                    const map = {'ã†':'ã‚','ã':'ã‹','ã':'ãŒ','ã™':'ã•','ã¤':'ãŸ','ã¬':'ãª','ã¶':'ã°','ã‚€':'ã¾','ã‚‹':'ã‚‰'};
                    resultEnd = map[plainEnd] + 'ãªã„';
                } else if (formType === 'te' || formType === 'ta') {
                    let suffix = formType === 'te' ? 'ã¦' : 'ãŸ';
                    let voicedSuffix = formType === 'te' ? 'ã§' : 'ã ';
                    if (['ã†','ã¤','ã‚‹'].includes(plainEnd)) resultEnd = 'ã£' + suffix;
                    else if (['ã‚€','ã¶','ã¬'].includes(plainEnd)) resultEnd = 'ã‚“' + voicedSuffix;
                    else if (plainEnd === 'ã') resultEnd = (stem === '[è¡Œ](ã„)' || stem === 'ã„') ? 'ã£' + suffix : 'ã„' + suffix;
                    else if (plainEnd === 'ã') resultEnd = 'ã„' + voicedSuffix;
                    else if (plainEnd === 'ã™') resultEnd = 'ã—' + suffix;
                }
            } else if (verb.group === 2) {
                // Ru-verbs
                if (formType === 'masu') resultEnd = 'ã¾ã™';
                else if (formType === 'nai') resultEnd = 'ãªã„';
                else if (formType === 'te') resultEnd = 'ã¦';
                else if (formType === 'ta') resultEnd = 'ãŸ';
            } else if (verb.group === 3) {
                // Irregular
                const isSuru = plainEnd === 'ã™ã‚‹';
                const isKuru = plainEnd === 'ãã‚‹';
                
                if (isSuru) {
                    if (formType === 'masu') resultEnd = 'ã—ã¾ã™';
                    if (formType === 'nai') resultEnd = 'ã—ãªã„';
                    if (formType === 'te') resultEnd = 'ã—ã¦';
                    if (formType === 'ta') resultEnd = 'ã—ãŸ';
                } else if (isKuru) {
                    // Kuru is tricky with kanji reading changes, simplified here
                    if (formType === 'masu') return 'æ¥(ã)ã¾ã™';
                    if (formType === 'nai') return 'æ¥(ã“)ãªã„';
                    if (formType === 'te') return 'æ¥(ã)ã¦';
                    if (formType === 'ta') return 'æ¥(ã)ãŸ';
                }
            }
            
            // Construct full string
            // Special case: Suru/Kuru base might be empty string for pure helper, or part of Kanji
            if (verb.kanji) {
                // e.g. è¡Œ + ã -> è¡Œ + ãã¾ã™
                return `[${verb.kanji}](${verb.kana})${resultEnd}`;
            } else {
                 // e.g. ãã‚‹ -> ãã¾ã™ (handled above mostly) or å‹‰å¼· + ã™ã‚‹
                 return `${stem}${resultEnd}`;
            }
        }

        // --- STATE & GAME LOGIC ---
        let state = {
            cards: [],
            matches: 0,
            selectedId: null,
            selectedVerbs: []
        };

        // --- UI HANDLERS ---
        function toggleVerbOpt(el) {
            el.classList.toggle('selected');
            const form = el.dataset.form;
            if (state.selectedVerbs.includes(form)) {
                state.selectedVerbs = state.selectedVerbs.filter(f => f !== form);
            } else {
                state.selectedVerbs.push(form);
            }
        }

        function startGame(mode) {
            let pool = [];
            if (mode === 'N3') pool = VOCAB_N3;
            else if (mode === 'N5') pool = VOCAB_N5;
            
            // Shuffle and pick 7
            pool = pool.sort(() => Math.random() - 0.5).slice(0, 7);
            
            // Create Pairs: Kanji/Kana <-> Meaning
            const pairs = pool.map(item => ({
                id: item.id,
                left: item.kanji, // Display with Ruby
                right: item.meaning,
                kana: item.kana, // For Audio
                isLeftJp: true
            }));
            
            initGame(pairs);
        }

        function startVerbGame() {
            if (state.selectedVerbs.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å˜å½¢å½¢å¼ï¼");
                return;
            }
            
            // Pick random verbs
            const pool = VERBS.sort(() => Math.random() - 0.5).slice(0, 7);
            
            const pairs = pool.map((v, idx) => {
                // Randomly pick one of the selected forms to match against Dictionary Form
                const targetForm = state.selectedVerbs[Math.floor(Math.random() * state.selectedVerbs.length)];
                const conjugated = conjugate(v, targetForm);
                
                // Pair: Dictionary Form <-> Conjugated Form
                // Display: [è¡Œ](ã„)ã <-> [è¡Œ](ã„)ãã¾ã™
                const dictForm = v.kanji ? `[${v.kanji}](${v.kana})${v.end}` : (v.kana || '') + v.end;
                
                return {
                    id: 'v_' + idx,
                    left: dictForm,
                    right: conjugated,
                    kana: v.kana + v.end, // Approx audio for dict form
                    isLeftJp: true,
                    isVerbMode: true
                };
            });
            
            initGame(pairs);
        }

        function initGame(pairs) {
            const jpOnLeft = Math.random() > 0.5;
            let leftCards = [], rightCards = [];

            pairs.forEach(p => {
                const txtA = jpOnLeft ? p.left : p.right;
                const txtB = jpOnLeft ? p.right : p.left;
                const typeA = jpOnLeft ? 'jp' : 'cn';
                const typeB = jpOnLeft ? 'cn' : 'jp';
                
                leftCards.push({ id: p.id+'-A', text: txtA, type: typeA, matchId: p.id, status: 'default', kana: p.kana });
                rightCards.push({ id: p.id+'-B', text: txtB, type: typeB, matchId: p.id, status: 'default', kana: p.kana });
            });

            state.cards = [...leftCards, ...rightCards];
            state.leftCards = leftCards.sort(() => Math.random() - 0.5);
            state.rightCards = rightCards.sort(() => Math.random() - 0.5);
            state.matches = 0;
            state.selectedId = null;

            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('score-display').innerText = "0 / 7";
            
            renderBoard();
            
            // Try to "warm up" audio on iOS
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(''); 
                window.speechSynthesis.speak(u);
            }
        }

        function renderBoard() {
            const leftEl = document.getElementById('col-left');
            const rightEl = document.getElementById('col-right');
            leftEl.innerHTML = ''; rightEl.innerHTML = '';
            
            state.leftCards.forEach(c => leftEl.appendChild(createCard(c)));
            state.rightCards.forEach(c => rightEl.appendChild(createCard(c)));
        }

        function createCard(card) {
            const el = document.createElement('div');
            el.className = `card ${card.status}`;
            el.dataset.id = card.id;
            el.onclick = () => handleCardClick(card.id);
            
            if (card.type === 'jp' || card.text.includes('[')) {
                // Ruby Parsing
                el.innerHTML = card.text.replace(/\[(.*?)\]\((.*?)\)/g, '<ruby>$1<rt>$2</rt></ruby>');
                // Add Sound Icon if JP
                if (card.type === 'jp' || card.text.match(/[\u3040-\u30ff]/)) {
                   el.innerHTML += '<span style="opacity:0.5; font-size:0.8rem; margin-left:4px"> ğŸ”Š</span>';
                }
            } else {
                el.innerText = card.text;
            }
            return el;
        }

        function handleCardClick(id) {
            const card = state.cards.find(c => c.id === id);
            if (!card || card.status === 'matched') return;

            // PLAY AUDIO
            // Logic: Play if it's the Japanese side, OR if we are in Verb Mode (both sides are JP)
            const isJp = card.type === 'jp' || card.text.match(/[ã-ã‚“ã‚¡-ãƒ³]/);
            if (isJp) {
                // Clean text for speaking: Remove [Kanji](reading) -> Reading
                // Also remove symbol characters
                let speakText = card.text.replace(/\[.*?\]\((.*?)\)/g, '$1');
                speak(speakText);
            }

            // GAME LOGIC
            if (state.selectedId === id) {
                state.selectedId = null;
                updateStatus(id, 'default');
                return;
            }

            if (!state.selectedId) {
                state.selectedId = id;
                updateStatus(id, 'selected');
            } else {
                const prevId = state.selectedId;
                const prevCard = state.cards.find(c => c.id === prevId);
                
                // Same column check
                const isLeft = state.leftCards.some(c => c.id === id);
                const isPrevLeft = state.leftCards.some(c => c.id === prevId);
                if (isLeft === isPrevLeft) {
                    updateStatus(prevId, 'default');
                    state.selectedId = id;
                    updateStatus(id, 'selected');
                    return;
                }

                if (prevCard.matchId === card.matchId) {
                    updateStatus(prevId, 'matched');
                    updateStatus(id, 'matched');
                    state.selectedId = null;
                    state.matches++;
                    document.getElementById('score-display').innerText = `${state.matches} / 7`;
                    if (state.matches === 7) {
                        setTimeout(() => {
                             document.getElementById('modal-overlay').classList.remove('hidden');
                             // Victory sound
                             speak("ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™");
                        }, 800);
                    }
                } else {
                    updateStatus(prevId, 'error');
                    updateStatus(id, 'error');
                    state.selectedId = null;
                    setTimeout(() => {
                        updateStatus(prevId, 'default');
                        updateStatus(id, 'default');
                    }, 600);
                }
            }
        }

        function updateStatus(id, status) {
            const card = state.cards.find(c => c.id === id);
            if (card) card.status = status;
            const el = document.querySelector(`.card[data-id="${id}"]`);
            if (el) el.className = `card ${status}`;
        }

        function quitGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('selection-screen').classList.remove('hidden');
        }

        // --- ROBUST AUDIO ---
        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP'; // Critical for iOS
            u.rate = 0.9;
            
            // iOS Safari Voice Fix: Find a Japanese voice
            const voices = window.speechSynthesis.getVoices();
            const jpVoice = voices.find(v => v.lang.includes('ja'));
            if (jpVoice) u.voice = jpVoice;
            
            window.speechSynthesis.speak(u);
        }
        
        // Ensure voices are loaded
        window.speechSynthesis.onvoiceschanged = () => {
            console.log("Voices loaded");
        };
</script>
</body>
</html>